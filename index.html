<!DOCTYPE html>
<html lang="es" data-bs-theme="light"> <!-- Añadido data-bs-theme -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temporizador Pomodoro</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        #time-left {
            font-weight: 300;
        }
        .card-body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 400px;
        }
        /* Estilo para el botón de tema */
        #theme-toggle-button {
            font-size: 1.5rem; /* Tamaño icono */
            line-height: 1; /* Alineación vertical */
        }
    </style>
</head>
<body>
    <!-- Botón para cambiar tema -->
    <button id="theme-toggle-button" class="btn position-fixed top-0 end-0 m-3 border-0" title="Cambiar tema">
        <i class="bi bi-moon-stars-fill"></i> <!-- Icono inicial (se cambiará con JS) -->
    </button>

    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow">
                    <div class="card-body">
                        <h1 class="card-title text-center mb-4">Temporizador Pomodoro</h1>

                        <div class="text-center">
                            <h5 id="timer-label">¡Listo para empezar!</h5>
                        </div>

                        <div id="time-left" class="display-1 text-center my-4">
                            25:00
                        </div>

                        <div class="text-center mb-4">
                            <button id="start-pause-button" class="btn btn-primary btn-lg">Iniciar</button>
                            <button id="reset-button" class="btn btn-secondary btn-lg ms-2">Reiniciar</button>
                        </div>

                        <div class="text-center mt-3">
                            <small id="pomodoro-count" class="text-muted">Pomodoros completados: 0</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Elemento Audio (oculto, o puedes omitirlo y crear con new Audio()) -->
    <!-- <audio id="alert-sound" src="alert.mp3" loop></audio> -->
    <!-- Asegúrate de tener un archivo alert.mp3 o cambia la ruta -->

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- JavaScript Personalizado -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuración ---
            const POMODORO_DURATION = 25 * 60;
            const SHORT_BREAK_DURATION = 5 * 60;
            const LONG_BREAK_DURATION = 15 * 60;
            const POMODOROS_PER_LONG_BREAK = 4;
            const ALERT_SOUND_SRC = 'alert.mp3'; // <-- IMPORTANTE: Cambia esto a la ruta de tu archivo de sonido

            // --- Referencias al DOM ---
            const timerLabelEl = document.getElementById('timer-label');
            const timeLeftEl = document.getElementById('time-left');
            const startPauseButton = document.getElementById('start-pause-button');
            const resetButton = document.getElementById('reset-button');
            const pomodoroCountEl = document.getElementById('pomodoro-count');
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const htmlElement = document.documentElement; // Referencia a <html>
            const themeIcon = themeToggleButton.querySelector('i'); // El icono dentro del botón

            // --- Iconos Tema ---
            const moonIconClass = 'bi-moon-stars-fill';
            const sunIconClass = 'bi-sun-fill';

            // --- Audio ---
            let alertSound;
            try {
                alertSound = new Audio(ALERT_SOUND_SRC);
                alertSound.loop = true;
            } catch (e) {
                console.error("No se pudo inicializar el objeto Audio. Asegúrate que la ruta del sonido sea correcta y accesible.", e);
                // Deshabilitar funciones de sonido si falla
                alertSound = { play: () => {}, pause: () => {}, currentTime: 0 };
            }
            let isSoundPlaying = false;
            let audioPrimed = false; // Flag para 'preparar' el audio

            // --- Variables de Estado (Temporizador) ---
            let timerInterval = null;
            let timeLeft = POMODORO_DURATION;
            let isRunning = false;
            let currentState = 'pomodoro';
            let pomodorosCompleted = 0;

            // --- Funciones Temporizador ---
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
            }

            function updateDisplay() {
                timeLeftEl.textContent = formatTime(timeLeft);
                pomodoroCountEl.textContent = `Pomodoros completados: ${pomodorosCompleted}`;

                let stateText = "Trabajo";
                if (currentState === 'shortBreak') stateText = "Descanso Corto";
                else if (currentState === 'longBreak') stateText = "Descanso Largo";
                timerLabelEl.textContent = stateText;

                document.title = `${formatTime(timeLeft)} - ${stateText}`;

                if (isRunning) {
                    startPauseButton.textContent = 'Pausar';
                    startPauseButton.classList.remove('btn-success', 'btn-primary');
                    startPauseButton.classList.add('btn-warning');
                } else {
                    if (timerInterval !== null || timeLeft < durationForState(currentState)) {
                       startPauseButton.textContent = 'Reanudar';
                       startPauseButton.classList.remove('btn-warning', 'btn-primary');
                       startPauseButton.classList.add('btn-success');
                    } else {
                       startPauseButton.textContent = 'Iniciar';
                       startPauseButton.classList.remove('btn-warning', 'btn-success');
                       startPauseButton.classList.add('btn-primary');
                    }
                }
            }

            function durationForState(state) {
                switch (state) {
                    case 'shortBreak': return SHORT_BREAK_DURATION;
                    case 'longBreak': return LONG_BREAK_DURATION;
                    case 'pomodoro': default: return POMODORO_DURATION;
                }
            }

            function stopAlertSound() {
                if (isSoundPlaying) {
                    alertSound.pause();
                    alertSound.currentTime = 0; // Reinicia para la próxima vez
                    isSoundPlaying = false;
                    console.log("Sonido de alerta detenido.");
                }
            }

             function decrementTime() {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateDisplay();
                } else {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    isRunning = false;

                    // Iniciar sonido de alerta
                    console.log("Iniciando sonido de alerta...");
                    alertSound.play().catch(e => console.error("Error al reproducir sonido:", e)); // Manejo de errores si play() falla
                    isSoundPlaying = true;

                    // Cambiar estado y actualizar UI
                    switchState();
                    updateDisplay();
                    // Ya no usamos alert()
                }
            }

             function toggleTimer() {
                 // Detener sonido si estaba sonando (porque el usuario interactúa)
                stopAlertSound();

                if (isRunning) { // Pausar
                    clearInterval(timerInterval);
                    timerInterval = null;
                    isRunning = false;
                } else { // Iniciar o Reanudar
                    isRunning = true;
                    if (timeLeft === durationForState(currentState) && timerInterval === null) {
                         timeLeft = durationForState(currentState);
                         // --- Audio Priming ---
                         if (!audioPrimed && alertSound.play) { // Solo intentar si alertSound es válido
                             console.log("Intentando preparar audio...");
                             alertSound.play().then(() => {
                                 alertSound.pause(); // Pausar inmediatamente después de empezar
                                 alertSound.currentTime = 0;
                                 audioPrimed = true;
                                 console.log("Contexto de audio preparado.");
                             }).catch(e => {
                                 console.warn("Fallo al preparar audio (puede ser normal si el usuario no ha interactuado aún):", e);
                                 // No necesariamente bloquea la funcionalidad futura si el navegador lo permite más tarde
                             });
                         }
                         //--------------------
                    }
                    timerInterval = setInterval(decrementTime, 1000);
                }
                updateDisplay();
            }

             function resetTimer() {
                 // Detener sonido si estaba sonando
                stopAlertSound();

                clearInterval(timerInterval);
                timerInterval = null;
                isRunning = false;
                timeLeft = durationForState(currentState);
                // Opcional: Reset total
                // currentState = 'pomodoro';
                // pomodorosCompleted = 0;
                // timeLeft = POMODORO_DURATION;
                updateDisplay();
            }

            function switchState() {
                 // El sonido se inicia en decrementTime antes de llamar a switchState
                if (currentState === 'pomodoro') {
                    pomodorosCompleted++;
                    if (pomodorosCompleted % POMODOROS_PER_LONG_BREAK === 0) {
                        currentState = 'longBreak';
                        timeLeft = LONG_BREAK_DURATION;
                    } else {
                        currentState = 'shortBreak';
                        timeLeft = SHORT_BREAK_DURATION;
                    }
                } else {
                    currentState = 'pomodoro';
                    timeLeft = POMODORO_DURATION;
                }
                 // Importante: No resetear isRunning aquí, ya se hizo en decrementTime
                 // No iniciar automáticamente el nuevo ciclo
                 isRunning = false;
                 clearInterval(timerInterval);
                 timerInterval = null;
                 // La actualización de display se llama después en decrementTime
            }

            // --- Funciones Tema ---
            function setTheme(theme) {
                htmlElement.setAttribute('data-bs-theme', theme);
                localStorage.setItem('theme', theme); // Guardar preferencia

                // Cambiar icono
                if (theme === 'dark') {
                    themeIcon.classList.remove(moonIconClass);
                    themeIcon.classList.add(sunIconClass);
                    themeToggleButton.setAttribute('title', 'Cambiar a modo claro');
                } else {
                    themeIcon.classList.remove(sunIconClass);
                    themeIcon.classList.add(moonIconClass);
                    themeToggleButton.setAttribute('title', 'Cambiar a modo oscuro');
                }
                console.log(`Tema cambiado a: ${theme}`);
            }

            function toggleTheme() {
                const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
            }

            // --- Inicialización ---
            function init() {
                // Listeners temporizador
                startPauseButton.addEventListener('click', toggleTimer);
                resetButton.addEventListener('click', resetTimer);

                // Listener tema
                themeToggleButton.addEventListener('click', toggleTheme);

                // Establecer tema inicial
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
                setTheme(initialTheme); // Aplica tema guardado o del sistema

                // Configurar estado inicial temporizador
                currentState = 'pomodoro';
                timeLeft = POMODORO_DURATION;
                updateDisplay(); // Mostrar estado inicial correctamente
            }

            init();
        });
    </script>
</body>
</html>
